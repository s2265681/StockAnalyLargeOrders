name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  SERVER_IP: "18.141.179.222"
  APP_DIR: "/var/www/app/StockAnalyLargeOrders"
  NODE_VERSION: "18"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ”‘ Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: ğŸ”¨ Build Frontend
      working-directory: frontend
      run: |
        # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶
        pwd
        ls -la
        
        # å®‰è£…ä¾èµ–
        npm install
        
        # åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
        cat > .env.production << EOF
        REACT_APP_API_BASE_URL=http://${{ env.SERVER_IP }}:9001
        REACT_APP_ENV=production
        REACT_APP_API_TIMEOUT=300000
        REACT_APP_DEBUG=false
        EOF
        
        # æ„å»ºé¡¹ç›®
        npm run build:prod
        
    - name: ğŸ—‚ï¸ Prepare Deployment Files
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deployment
        
        # å¤åˆ¶åç«¯Pythonä»£ç 
        cp -r backend/ deployment/
        
        # å¤åˆ¶æ ¹ç›®å½•çš„Pythonåˆ†æè„šæœ¬
        cp data_formatter.py deployment/ 2>/dev/null || true
        cp data_analysis.py deployment/ 2>/dev/null || true
        
        # å¤åˆ¶å¯åŠ¨è„šæœ¬
        cp start.sh deployment/ 2>/dev/null || true
        cp stop.sh deployment/ 2>/dev/null || true
        
        # å¤åˆ¶å‰ç«¯æ„å»ºæ–‡ä»¶
        mkdir -p deployment/frontend-dist
        cp -r frontend/build/* deployment/frontend-dist/ 2>/dev/null || true
        
        # æ˜¾ç¤ºéƒ¨ç½²æ–‡ä»¶ç»“æ„
        echo "ğŸ“ éƒ¨ç½²æ–‡ä»¶ç»“æ„ï¼š"
        ls -la deployment/
        
    - name: ğŸ“¤ Deploy to Server
      run: |
        # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
        ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        ssh ubuntu@${{ env.SERVER_IP }} "sudo mkdir -p /var/www/app && sudo chown \$USER:\$USER /var/www/app"
        
        # æ¸…ç†æ—§æ–‡ä»¶
        ssh ubuntu@${{ env.SERVER_IP }} "rm -rf ${{ env.APP_DIR }} && mkdir -p ${{ env.APP_DIR }}"
        
    - name: ğŸ“ Upload Files
      run: |
        # ä½¿ç”¨scpä¸Šä¼ æ–‡ä»¶
        scp -r deployment/* ubuntu@${{ env.SERVER_IP }}:${{ env.APP_DIR }}/
        
    - name: ğŸš€ Execute Deployment
      run: |
        ssh ubuntu@${{ env.SERVER_IP }} << 'EOF'
          cd ${{ env.APP_DIR }}
          
          echo "ğŸ è®¾ç½®Pythonç¯å¢ƒ..."
          python3 -m venv venv 2>/dev/null || echo 'venvå·²å­˜åœ¨'
          source venv/bin/activate
          
          echo "â¬†ï¸ å‡çº§pip..."
          pip install --upgrade pip
          
          echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
          # ä½¿ç”¨backendç›®å½•ä¸‹çš„requirements.txt
          if [ -f backend/requirements.txt ]; then
            pip install --no-cache-dir -r backend/requirements.txt
          elif [ -f requirements.txt ]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "âŒ æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          pm2 delete StockAnalysisLargeOrders 2>/dev/null || echo 'æœåŠ¡ä¸å­˜åœ¨ï¼Œæ–°å»ºä¸­...'
          
          echo "ğŸ§¹ æ¸…ç†ç«¯å£å ç”¨..."
          lsof -ti:9001 | xargs kill -9 2>/dev/null; echo "æ¸…ç†å®Œæˆ"
          
          echo "ğŸ“ ç¡®è®¤Pythonè§£é‡Šå™¨è·¯å¾„..."
          PYTHON_PATH=$(pwd)/venv/bin/python
          echo "Python path: $PYTHON_PATH"
          $PYTHON_PATH --version
          
          echo "ğŸš€ å¯åŠ¨PM2æœåŠ¡..."
          # ä½¿ç”¨backendç›®å½•ä¸‹çš„app.pyå¯åŠ¨
          if [ -f backend/app.py ]; then
            pm2 start backend/app.py --name StockAnalysisLargeOrders --interpreter $PYTHON_PATH
          else
            echo "âŒ æœªæ‰¾åˆ°backend/app.pyæ–‡ä»¶"
            exit 1
          fi
          pm2 save
          
          echo "ğŸ“Š æ£€æŸ¥PM2çŠ¶æ€..."
          pm2 status
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        EOF
          
    - name: ğŸ” Health Check
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
        for i in {1..5}; do
          if curl -f http://${{ env.SERVER_IP }}:9001/health 2>/dev/null; then
            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"
            break
          elif curl -f http://${{ env.SERVER_IP }}:9001/ 2>/dev/null; then
            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"
            break
          else
            echo "â³ æœåŠ¡è¿˜æœªå°±ç»ªï¼Œç­‰å¾…ä¸­... ($i/5)"
            sleep 15
          fi
        done
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
        echo "  - APIæœåŠ¡: http://${{ env.SERVER_IP }}:9001/"
        echo "  - å¥åº·æ£€æŸ¥: http://${{ env.SERVER_IP }}:9001/health"
        echo ""
        echo "ğŸ“Š æœåŠ¡æ¶æ„ï¼š"
        echo "  - åç«¯: Flaskåº”ç”¨ (ç«¯å£9001)"
        echo "  - è¿›ç¨‹ç®¡ç†: PM2å®ˆæŠ¤è¿›ç¨‹"
        echo "  - å‰ç«¯: é™æ€æ–‡ä»¶éƒ¨ç½²" 