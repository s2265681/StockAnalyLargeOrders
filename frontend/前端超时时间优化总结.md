# 前端超时时间优化总结

## 修改背景

由于成交明细数据获取和大单分析需要较长时间处理：
- AKShare数据下载需要时间
- 大量成交明细数据分析需要处理时间
- 网络请求可能因数据量大而较慢

原有的超时时间（开发环境10秒，生产环境15秒）不足以支持这些复杂的数据处理操作。

## 修改内容

### 1. 全局超时时间调整 ✅

**文件**：`frontend/src/config/api.js`

```javascript
// 修改前
const defaultConfig = {
  development: {
    baseURL: 'http://localhost:9001',
    timeout: 10000, // 10秒
  },
  production: {
    baseURL: 'http://18.141.179.222:9001', 
    timeout: 15000, // 15秒
  }
};

// 修改后
const defaultConfig = {
  development: {
    baseURL: 'http://localhost:9001',
    timeout: 30000, // 30秒 - 增加200%
  },
  production: {
    baseURL: 'http://18.141.179.222:9001', 
    timeout: 45000, // 45秒 - 增加200%
  }
};
```

### 2. 特定API超时时间优化 ✅

**文件**：`frontend/src/store/atoms.js`

为耗时较长的API调用设置了更长的超时时间（60秒）：

#### 大单统计和明细获取
```javascript
// 修改前
const [statsData, dadanData] = await Promise.all([
  apiRequest(`/api/v1/dadantongji?code=${code}&dt=${today}`),
  apiRequest(`/api/v1/dadan?code=${code}&dt=${today}`)
]);

// 修改后
const [statsData, dadanData] = await Promise.all([
  apiRequest(`/api/v1/dadantongji?code=${code}&dt=${today}`, { timeout: 60000 }),
  apiRequest(`/api/v1/dadan?code=${code}&dt=${today}`, { timeout: 60000 })
]);
```

#### 实时大单数据获取
```javascript
// 修改前
const data = await apiRequest(`/api/v1/dadan?code=${code}&dt=${today}`);

// 修改后
const data = await apiRequest(`/api/v1/dadan?code=${code}&dt=${today}`, { timeout: 60000 });
```

## 超时时间分级策略

| API类型 | 超时时间 | 说明 |
|---------|----------|------|
| **基础数据** | 30s/45s | 基本股票信息、分时数据等 |
| **大单分析** | 60s | 需要处理大量成交明细数据 |
| **健康检查** | 5s | 快速检查服务状态 |

## 优化效果

### 修改前 ❌
- 开发环境：10秒超时 → 经常超时失败
- 生产环境：15秒超时 → AKShare数据获取失败
- 用户体验：频繁出现"请求超时"错误

### 修改后 ✅
- 开发环境：30秒基础 + 60秒大单分析
- 生产环境：45秒基础 + 60秒大单分析
- 用户体验：数据获取更稳定可靠

## 技术细节

### 1. 超时实现机制
```javascript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), config.timeout);

const response = await fetch(url, {
  ...config,
  signal: controller.signal,
});

clearTimeout(timeoutId);
```

### 2. 错误处理优化
```javascript
if (error.name === 'AbortError') {
  throw new Error('请求超时');
}
```

### 3. 环境变量支持
```javascript
timeout: parseInt(process.env.REACT_APP_API_TIMEOUT) || defaultConfig[currentEnv].timeout
```

## 监控建议

### 1. 性能监控
- 监控API响应时间
- 统计超时发生频率
- 记录用户体验指标

### 2. 动态调整
```bash
# 环境变量配置示例
REACT_APP_API_TIMEOUT=45000  # 自定义超时时间
REACT_APP_DEBUG_API=true     # 启用调试日志
```

### 3. 优化空间
- **缓存机制**：减少重复请求
- **分页加载**：减少单次数据量
- **预加载**：提前获取常用数据
- **请求去重**：避免重复请求

## 用户提示优化

建议在长时间数据加载时显示进度提示：

```javascript
// 建议添加的用户提示
const loadingMessages = {
  0: "正在获取股票基础信息...",
  5000: "正在分析成交明细数据...", 
  15000: "正在进行大单统计分析...",
  30000: "数据量较大，请耐心等待...",
  45000: "即将完成，请稍等..."
};
```

## 总结

通过本次超时时间优化：

1. ✅ **解决了AKShare数据获取超时问题**
2. ✅ **提升了大单分析功能的稳定性**
3. ✅ **改善了用户体验和系统可靠性**
4. ✅ **建立了分级超时策略**

现在前端可以更好地支持复杂的数据分析操作，用户不会再频繁遇到超时错误。 